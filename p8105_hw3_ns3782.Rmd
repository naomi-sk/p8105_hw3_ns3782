---
title: "p8105_hw3_ns3782"
author: "NSK"
date: "2024-10-13"
output: github_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(
  fig.width = 15,       
  fig.asp = 0.7,         
  out.width = "100%",    
  dpi = 300,
  message = FALSE,
  warning = FALSE
)

```

# Problem 1

## Import Data 

```{r problem_1_setup}

# Load libraries and import data

library(p8105.datasets)
library(tidyverse)

data("ny_noaa")


```

## Dataset Overview

The NY NOAA dataset contains `r nrow(ny_noaa)` observations of `r ncol(ny_noaa)` weather related variables, corresponding to daily weather data collected from `r ny_noaa %>% pull(id) %>% unique() %>% length()` unique weather stations in New York City. The date range of the observations is from `r min(ny_noaa$date)` to `r max(ny_noaa$date)`. 

Key variables and their types include: `id` (`r class(ny_noaa$id)`, weather station identifier), `date` (`r class(ny_noaa$date)`, YYYY-MM-DD), `prcp` (`r class(ny_noaa$prcp)`, precipitation), `snow` (`r class(ny_noaa$snow)`, snowfall), `snwd` (`r class(ny_noaa$snwd)`, snow depth), `tmax` (`r class(ny_noaa$tmax)`, maximum temperature), `tmin` (`r class(ny_noaa$tmin)`, minimum temperature).

Missing data is an issue in this dataset. The total number of missing values across all variables is `r sum(is.na(ny_noaa))`, which represents `r round(sum(is.na(ny_noaa)) / (nrow(ny_noaa) * ncol(ny_noaa)) * 100, 2)`% of all observations in the dataset. 

For the id variable, there are `r sum(is.na(ny_noaa$id))` missing values (`r round(sum(is.na(ny_noaa$id)) / nrow(ny_noaa) * 100, 2)`% of total observations). The date variable has `r sum(is.na(ny_noaa$date))` missing values (`r round(sum(is.na(ny_noaa$date)) / nrow(ny_noaa) * 100, 2)`% of total observations). Precipitation (prcp) has `r sum(is.na(ny_noaa$prcp))` missing values (`r round(sum(is.na(ny_noaa$prcp)) / nrow(ny_noaa) * 100, 2)`% of total observations). For snowfall (snow), there are `r sum(is.na(ny_noaa$snow))` missing values (`r round(sum(is.na(ny_noaa$snow)) / nrow(ny_noaa) * 100, 2)`% of total observations). Snow depth (snwd) has `r sum(is.na(ny_noaa$snwd))` missing values (`r round(sum(is.na(ny_noaa$snwd)) / nrow(ny_noaa) * 100, 2)`% of total observations). Maximum temperature (tmax) has `r sum(is.na(ny_noaa$tmax))` missing values (`r round(sum(is.na(ny_noaa$tmax)) / nrow(ny_noaa) * 100, 2)`% of total observations). Minimum temperature (tmin) has `r sum(is.na(ny_noaa$tmin))` missing values (`r round(sum(is.na(ny_noaa$tmin)) / nrow(ny_noaa) * 100, 2)`% of total observations).

## Clean Data

In the process of cleaning the NOAA weather data, I undertook several unit conversions to improve interpretability of the weather data. Precipitation was changed from tenths of mm to mm, while snowfall and snow depth were converted from mm to cm. These are in line with typical measures used for these data. Maximum and minimum temperatures were also adjusted from tenths of degrees Celsius to whole degrees Celsius. These conversions were made to standardise units across the weather variables and enable easier subsequent analysis.

```{r problem_1_cleaning}

# Data cleaning

ny_noaa_clean <- ny_noaa %>%
  mutate(
    date = as.Date(date),
    year = lubridate::year(date),
    month = lubridate::month(date),
    day = lubridate::day(date),
    prcp = prcp / 10, 
    snow = snow / 10, 
    snwd = snwd / 10,  
    tmax = as.numeric(tmax) / 10, 
    tmin = as.numeric(tmin) / 10   
  )


# Most common snowfall values
ny_noaa_clean %>%
  count(snow) %>%
  arrange(desc(n)) %>%
  head(5)


```

## Most Common Snowfall values

The most common snowfall values for NYC are `r ny_noaa_clean %>% count(snow) %>% arrange(desc(n)) %>% pull(snow) %>% .[1]` cm (`r ny_noaa_clean %>% count(snow) %>% arrange(desc(n)) %>% pull(n) %>% .[1]` occurrences), followed by NA (`r sum(is.na(ny_noaa_clean$snow))` occurrences). 0 is the most common, likely due to New York City rarely having snow year round particularly in recent years, while NA represents missing data. The next most common values are `r ny_noaa_clean %>% filter(!is.na(snow), snow > 0) %>% count(snow) %>% arrange(desc(n)) %>% pull(snow) %>% head(3) %>% paste(collapse = ", ")` cm, which are 1 inch, 0.5 inch, and 2 inches respectively. These are indicative of typical light to moderate snowfall events, which would be expected of New York City during colder months.

## Average max temperature in January and in July

```{r problem_1_plot}

# Load libraries
library(ggplot2)

# Two-panel plot

temp_plot <- ny_noaa_clean %>%
  filter(month %in% c(1, 7), !is.na(tmax)) %>%
  group_by(id, year, month) %>%
  summarise(avg_tmax = mean(tmax, na.rm = TRUE)) %>%
  ungroup() %>%
  ggplot(aes(x = year, y = avg_tmax, group = id, color = id)) +
  geom_line(alpha = 0.3) +
  facet_wrap(~month, scales = "free_y", 
             labeller = labeller(month = c("1" = "January", "7" = "July"))) +
  labs(title = "Average Maximum Temperature in January and July by Station (Celsius)",
       x = "Year", y = "Average Max Temperature (Celsius)") +
  theme(legend.position = "none")

print(temp_plot)



```

There are several observations based on the two-panel plot showing the average max temperature in January and in July in each station across years.
First, expected seasonal differences in maximum temperature are observable between the winter and summer months in New York. July temperatures are consistently higher on average (20-35°C) than January temperatures (-10 to 10°C).
Second, January temperatures appear to have more variability than July temperatures, which may be typical for NYC's climate.
Third, there is a spike in maximum temperatures for July 2010. Several stations show temperatures reaching or exceeding 30°C. This appears to be the highest point on the entire July graph, suggesting that July 2010 may have been the hottest July in the 30-year period shown.
Lastly, concerning outliers. The month of January shows comparatively more extreme outliers compared to July, with some years in January observed to have unusually low or high temperatures. This is especially apparent around 1982, where there is a dip in temperature below -10°C. July has fewer extreme outliers, but there is a notable dip around 1988 for one weather station to below 15°C suggesting a significant weather event, or weather station recording error. 

## Two-panel Plot: (i) Tmax vs Tin (ii) Snowfall values greater than zero and less than one hundred

```{r problem_1_plot2}

# Load required libraries 

library(patchwork)
library(ggridges)
library(viridis)

# Panel 1: tmax vs tmin as a hex plot

p1_nyc_noaa_plot <- ny_noaa_clean %>%
  select(tmin, tmax) %>%
  filter(!is.na(tmin) & !is.na(tmax)) %>%
  ggplot(aes(x = tmax, y = tmin)) +
  geom_hex(bins = 30, color = "white", linewidth = 0.1) +  
  scale_fill_viridis_c(option = "mako", name = "count", direction = -1) + 
  labs(title = "Maximum and Minimum Temperatures in New York City (1981-2010)", 
       x = "Maximum temperature (Celsius)", y = "Minimum temperature (Celsius)") +
  theme_minimal() +
  theme(
    panel.grid.major = element_line(color = "gray90"),
    panel.grid.minor = element_blank(),
    legend.position = "right",
    aspect.ratio = 0.8
  ) 

# Panel 2: Ridge plot of snowfall values greater than 0 and less than 100

p2_nyc_noaa_plot <- ny_noaa_clean %>%
  filter(snow > 0, snow < 100) %>%
  ggplot(aes(x = snow, y = factor(year))) +
  geom_density_ridges(
    scale = 3, 
    bandwidth = 0.7, 
    alpha = 0.8,
    fill = "steelblue",
    color = "darkblue"
  ) +
  scale_x_continuous(limits = c(-3, 100), expand = c(0, 0)) +
  labs(title = "Distribution of Snowfall in New York City (1981-2010)", 
       x = "Snowfall (cm)", y = "Year")

# Combine plots and adjust layout

p1_nyc_noaa_plot + p2_nyc_noaa_plot +
  plot_layout(ncol = 2, widths = c(1, 1))

```


# Problem 2: NHANES Accelerometer Study

## Importing, Cleaning, and Merging Datasets

```{r problem_2_setup}

# Import and clean nhanes_covar csv

nhanes_covar <- read_csv("./data/nhanes_covar.csv", skip = 4) %>% 
  janitor::clean_names() 

# Import and clean results nhanes_accel csv

nhanes_accel <- read_csv("./data/nhanes_accel.csv") %>% 
  janitor::clean_names() 

# Merge datasets

nhanes_merged <- nhanes_covar %>%
  left_join(nhanes_accel, by = "seqn")

# Exclude participants less than 21 years of age and missing demographic data

nhanes_cleaned <- nhanes_merged %>%
  filter(age >= 21) %>%
  drop_na(sex, age, bmi, education)

# Check variable types

str(nhanes_cleaned, list.len = 10)

# Code variable classes

nhanes_cleaned <- nhanes_cleaned %>%
  mutate(
    sex = factor(sex, 
                 levels = c(1, 2), 
                 labels = c("male", "female")),
    education = factor(education, 
                       levels = c(1, 2, 3),
                       labels = c("Less than high school", 
                                  "High school equivalent", 
                                  "More than high school"),
                       ordered = TRUE)
  )

```

As part of the initial data wrangling process for Problem 2, I imported two datasets containing relevant NHANES study information, including demographic information (nhanes_covar) and accelerometer datasets (nhanes_accel). I proceeded to clean variable names in both using the janitor function. Subsequently, I merged these datasets using a left join on the 'seqn' variable, as this represents the sequence number or unique identifier for each observation (participant) in NHANES. 
The resulting dataset was filtered to include only participants aged 21 and older as specified, and rows with missing demographic data were removed. Finally, I recoded the 'sex' and 'education' variables as factors with appropriate labels, with 'education' set as an ordered factor. This process resulted in a clean, merged dataset ready for analysis, with correctly formatted categorical variables for sex and education level.

## Participant Count by Sex and Education Level

```{r problem_2_summary_viz}

# Load and install necessary package

library(knitr)

# Create summary table

education_sex_table <- nhanes_cleaned %>%
  group_by(education, sex) %>%
  summarise(count = n(), .groups = 'drop') %>%
  pivot_wider(names_from = sex, values_from = count) %>%
  mutate(Total = male + female) %>%
  rename(Male = male, Female = female) %>%
  bind_rows(
    summarise(., education = "Total", 
              Male = sum(Male, na.rm = TRUE), 
              Female = sum(Female, na.rm = TRUE), 
              Total = sum(Total, na.rm = TRUE))
  )

# Display the table

kable(education_sex_table, caption = "NHANES Accelerometer Study: Participant Count by Sex and Education Level") 

```

The table shows the distribution participants in the NHANES Accelerometer Study across sex and education levels. A total of 228 participants are observed. There is relatively balanced representation of males (118) and females (110) in this sample. In each education group, there is an approximately equal number of males and females, with exception of the high school equivalent group where there are more males than females.
There appears to be a greater number of participants with higher education in this sample, as noted by the number of participants with advanced education compared to those with less than high school or equivalent, which may reflect broader educational trends or potential selection bias in the study. Approximately half of the participants (115) have more than a high school education, indicating a skew towards higher education levels in the sample.

## Age Distribution by Sex and Education Level 

```{r problem_2_age_sex_viz}

# Plot age distribution by sex and education level

ggplot(nhanes_cleaned, aes(x = age, y = sex, fill = sex)) + 
  geom_density_ridges(alpha = 0.7) +
  facet_wrap(~ education, ncol = 1, strip.position = "right") + 
  labs(y = "Sex",
       x = "Age in years",
       fill = "Sex",
       title = "Age Distribution by Sex and Education in NHANES Accelerometer Study")  +
  theme(
    strip.text.y.right = element_text(angle = 0),  
    strip.background = element_blank(),
    legend.position = "bottom", 
    legend.box = "horizontal", 
    plot.title = element_text(size = 12) 
  )

```

The ridge plot shows varying age distributions across education levels and sexes in the NHANES Accelerometer Study. 
For those with less than high school education, the age distribution skews older for both sexes, with a peak around 60-70 years. The high school equivalent category shows a more uniform age spread, particularly for males. 
A noteworthy observation is that the "More than high school" group skews comparatively younger in age compared to the other education groups, especially for females, with a pronounced peak around 30-40 years. This suggests generational differences in educational attainment, with a greater number of younger participants, especially young females, having higher education levels in the current sample. 
The plot also reveals sex differences, particularly in higher education, where females show a stronger representation in younger age groups compared to males. These observations align with the participant counts in the accompanying table, which shows a higher number of participants (115) in the "More than high school" category. 

## Total Daily Activity vs Age, by Sex and Education Level

```{r problem_2_total_activity}

# Calculate total activity and add it to nhanes_cleaned

nhanes_cleaned <- nhanes_cleaned %>%
  rowwise() %>%
  mutate(total_activity = sum(c_across(min1:min1440), na.rm = TRUE)) %>%
  ungroup()

# Create the plot

ggplot(nhanes_cleaned, aes(x = age, y = total_activity, color = sex)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "loess", se = FALSE) +
  facet_wrap(~ education, ncol = 1) +
  scale_color_manual(values = c("male" = "purple", "female" = "skyblue")) +
  labs(title = "Total Daily Activity vs Age by Sex and Education Level",
       x = "Age (years)",
       y = "Total Daily Activity (MIMS)",
       color = "Sex") 


```

Based on the plot, there is a general observable trend of decreasing activity with age across the different education categories, though this rate of and extent of decline varies depending on sex and education level. In the "Less than high school" group, men appear to have slightly higher activity levels than women in middle age, which declines to be close to equivalent in old age (70-80 years). 
The "High school equivalent" category shows that females tend to have higher activity levels in in their 20s, declining to have similar activity levels to males around age 60.
The "More than high school" group shows a similar distribution of activity levels between the sexes. However, around age 50 females have a slight spike in activity levels compared to men. This difference then declines, and by age 80, the activity levels between sexes in this education group become similar.

## 24-hour Activity Time Courses by Education Level and Sex

```{r problem2_24hr_activity}

# Pivot dataset from wide to long to get minute var

nhanes_long <- nhanes_cleaned %>%
  pivot_longer(cols = starts_with("min"), 
               names_to = "minute", 
               values_to = "activity",
               names_prefix = "min") %>%
  mutate(minute = as.numeric(minute))

# Create three-panel plot

ggplot(nhanes_long, aes(x = minute, y = activity, color = sex)) +
  geom_smooth(se = FALSE) +
  facet_wrap(~ education, ncol = 1) +
scale_x_continuous(breaks = seq(0, 1440, 180),
                     labels = c("00:00", "03:00", "06:00", "09:00", "12:00", "15:00", "18:00", "21:00", "24:00")) +
  scale_color_manual(values = c("male" = "purple", "female" = "skyblue")) +
  labs(title = "24-hour Activity Time Courses by Education Level and Sex",
       x = "Time of Day",
       y = "Activity (MIMS)",
       color = "Sex")

```

Overall, based on the three-panel plot, there is a common daily rhythm observed all education levels, with activity lowest during night hours, sharply increasing around 6:00 AM, and gradually declining towards the evening and nighttime hours.
In the "Less than high school" group, activity patterns are similar between males and females, with males showing slightly higher activity during night hours. 
The "High school equivalent" category displays a more pronounced difference, with females demonstrating higher activity levels throughout most of the day, particularly from mid-morning to early evening. Further, this trend is also more notable in the "More than high school" group, where females consistently show higher activity levels across the entire day.  However, the "More than high school" group maintains higher activity levels for a longer period during the day compared to other groups. Overall, these data suggest higher education levels are associated with more pronounced sex-based differences in activity, which may be linked to occupational or lifestyle activities differing between these groups.

# Problem 3: New York Bike Citi Bike Usage

## Importing, Cleaning and Merging Datasets

```{r problem_3_dataclean}

# Import and clean Jan 2020 csv

citi_jan2020 <- read_csv("./data/Jan 2020 Citi.csv") %>% 
  janitor::clean_names() 

# Import and clean results Jan 2024 csv

citi_jan2024 <- read_csv("./data/Jan 2024 Citi.csv") %>% 
  janitor::clean_names() 

# Import and clean July 2020 csv

citi_july2020 <- read_csv("./data/July 2020 Citi.csv") %>% 
  janitor::clean_names() 

# Import and clean results July 2024 csv

citi_july2024 <- read_csv("./data/July 2024 Citi.csv") %>% 
  janitor::clean_names() 

```

Following importing and cleaning the data, I checked whether the variable names and data types were consistent across the datasets before performing a merge.

```{r problem3_checkdata, results='hide'}

# Check to see variable names and data types in each dataset

map(list(citi_jan2020, citi_jan2024, citi_july2020, citi_july2024), names)
map(list(citi_jan2020, citi_jan2024, citi_july2020, citi_july2024), sapply, class)

```

Given that the variable names and data types were consistent, I proceeded with a merge of the datasets.

```{r problem3_merge}

# Merge datasets

citi_rides_full <- bind_rows(
  citi_jan2020 %>% mutate(year = 2020, month = "January"),
  citi_jan2024 %>% mutate(year = 2024, month = "January"),
  citi_july2020 %>% mutate(year = 2020, month = "July"),
  citi_july2024 %>% mutate(year = 2024, month = "July")
)

```

## NYC Citi Bike Dataset Overview

The final Citi Bike rides dataset for New York City contains `r nrow(citi_rides_full)` rows and `r ncol(citi_rides_full)` columns.

Key variables include `ride_id` (`r class(citi_rides_full$ride_id)`), a unique identifier for each ride; `rideable_type` (`r class(citi_rides_full$rideable_type)`), indicating the type of bike used; `weekdays` (`r class(citi_rides_full$weekdays)`), showing the day of the week; `duration` (`r class(citi_rides_full$duration)`), representing the length of the ride in minutes; `start_station_name` and `end_station_name` (both `r class(citi_rides_full$start_station_name)`), representing the names of the starting and ending stations respectively; `member_casual` (`r class(citi_rides_full$member_casual)`), indicating the rider's membership status; and `year` and `month` (both `r class(citi_rides_full$year)`), indicating when the ride took place.

The total number of missing values across all variables is `r sum(is.na(citi_rides_full))`, which represents `r round(sum(is.na(citi_rides_full)) / (nrow(citi_rides_full) * ncol(citi_rides_full)) * 100, 2)`% of all observations in the dataset.

## Citi Bike Rides by Rider Status (Jan 2020, July 2020, Jan 2024, July 2024)

```{r problem_3_summary_table}

# Load janitor library

library(janitor)

# Create table of ride counts

citi_rides_full %>% 
  mutate(Period = paste(year, month)) %>%
  tabyl(Period, member_casual) %>%
  adorn_totals("row") %>%
  adorn_totals("col") %>%
  rename("Casual Riders" = casual, "Members" = member) %>%
  kable(caption = "Total number of Citi Bike rides (Jan 2020, July 2020, Jan 2024, July 2024) by rider status")

```

Based on the table, there appears to be a seasonal trend in citi bike usage in New York. July has higher ridership than January in both 2020 and 2024, indicating people are not using citi bikes as frequently during winter.

Overall, there has been a major increase in citibike usage from 2020, with total rides more than tripling from January 2020 to July 2024 (as the total rides went from `12,420` in January 2020 to `47,156` in July 2024). While regular members comprise the majority of riders across all periods, the proportion of casual riders appears to have increased over time, particularly in July 2024 where casual riders made up `r round(10894 / 47156 * 100, 1)`% of total rides, suggesting the rising popularity of Citi Bike among new users between 2020-2024.

## Five most popular Citi Bike starting stations in July 2024

```{r problem3_countride_top5}

# Create table of count rides per starting station (July 2024)

citi_rides_full %>%
  filter(month == "July" & year == "2024") %>%
  count(start_station_name, sort = TRUE) %>%
  top_n(5, n) %>%
  rename("Starting Station" = start_station_name, "Number of Rides" = n) %>%
  kable(caption = "5 most popular Citi Bike starting stations in July 2024")

```

Based on the data, it appears that Pier 61 at Chelsea Piers was the most popular starting point for Citi Bike users in July 2024.

## Median Citi Bike Ride Duration by Day of Week, Month, and Year

```{r problem3_medianride_effects}

# Create plot looking at effects of vars on median ride duration

citi_rides_full %>%
  mutate(
    weekday = factor(weekdays, levels = c("Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday")),
    year = factor(year)
  ) %>%
  group_by(year, month, weekday) %>%
  summarise(median_duration = median(duration), .groups = 'drop') %>%
  ggplot(aes(x = weekday, y = median_duration, fill = year)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~ month, ncol = 1) +
  labs(
    title = "Median Ride Duration by Day of Week, Month, and Year",
    x = "Day of Week",
    y = "Median Duration (minutes)",
    fill = "Year"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.x = element_blank(),
    panel.grid.minor.x = element_blank()
  ) +
  scale_fill_brewer(palette = "Set2")

```

In January, median ride durations are consistently shorter compared to July for both 2020 and 2024, likely due to the colder weather discouraging longer rides. There is a noticeable weekend effect in both months, with Saturday and Sunday showing longer median ride durations in both 2020 and 2024, which suggests people may have longer rides for recreational purposes.

Interestingly, ride durations in 2024 are generally shorter than in 2020 across all days and both months, which may be influenced by the impact of the COVID-19 pandemic in 2020. People may have utilised citi bikes for longer rides as an alternative to public transport or as a form of exercise when other options were limited. The difference between weekday and weekend ride durations is more pronounced in July than in January, which may be influenced by better weather conditions encouraging longer recreational rides in the summer.

## Effects of month, membership status, and bike type on Citi Bike ride duration

```{r problem3_rideduration}

# Create plot looking at effects of vars on ride duration

citi_rides_full %>%
  filter(year == 2024) %>%
  mutate(
    member_casual = factor(member_casual, levels = c("casual", "member"), 
                           labels = c("Casual", "Member")),
    rideable_type = factor(rideable_type, 
                           levels = c("classic_bike", "electric_bike"),
                           labels = c("Classic Bike", "Electric Bike"))
  ) %>%
  ggplot(aes(x = rideable_type, y = duration, fill = rideable_type)) +
  geom_boxplot(outlier.alpha = 0.3) +
  facet_grid(month ~ member_casual) +
  scale_y_continuous(limits = c(0, 60), breaks = seq(0, 60, 15)) +
  scale_fill_manual(values = c("Classic Bike" = "skyblue", "Electric Bike" = "yellow")) +
  labs(
    title = "Distribution of Ride Duration in 2024",
    subtitle = "By Month, Membership Status, and Bike Type",
    x = "Bike Type",
    y = "Ride Duration (minutes)",
    fill = "Bike Type"
  ) +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.background = element_blank())

```

Considering the impact of membership status, it appears as though that casual riders generally have longer ride durations compared to members. This is evident from the higher median lines and larger interquartile ranges in the boxplots for casual riders, across both January and July as well as bike types. This suggests that casual riders may tend to use citi bikes for recreation or tourism, while members could be using them for shorter, more routine commuter trips.

Bike type may also impact ride duration, but not uniformly. For casual riders, the boxplots show that electric bikes have consistently lower median ride durations and smaller interquartile ranges compared to classic bikes in both January and July, indicating shorter ride durations for electric bikes among this user group. However this difference does not seem to be notable for citi bike members, as the boxes for classic and electric bikes are overlapping and of similar size across both months.

There do not appear major differences in citi bike usage based on month. For citi bike members, ride durations remain relatively consistent across both January and July. While casual riders show a slight tendency for marginally longer rides in January compared to July, the difference appears to be small with substantial overlap in the distributions. 

